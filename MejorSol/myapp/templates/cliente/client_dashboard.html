{% load static %}
<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Cliente - SIEER Chile</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link rel="stylesheet" href="{% static 'css/base.css' %}">
    
    <style>
        /* =========================================
           1. VARIABLES & TEMA (NEÓN OSCURO)
           ========================================= */
        :root {
            --neon-green: #00ff88;
            --neon-hover: #00cc6a;
            --bg-dark: #050505;     /* Fondo principal casi negro absoluto */
            --bg-panel: #0f0f0f;    /* Fondo de tarjetas/sidebar */
            --glass-bg: rgba(15, 15, 15, 0.95);
            --border-neon: 1px solid rgba(0, 255, 136, 0.3);
            --text-white: #ffffff;
            --text-gray: #b0b0b0;
        }

        body {
            background-color: var(--bg-dark);
            /* Fondo sutil para dar profundidad */
            background-image: url("{% static 'img/fondo.png' %}"); /* Asegúrate que esta ruta exista o quítala */
            background-size: cover;
            background-attachment: fixed;
            background-blend-mode: overlay;
            color: var(--text-white);
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding-top: 70px; /* Espacio para el header fijo */
            overflow-x: hidden;
        }

        /* Scrollbar personalizada */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--neon-green); }

        /* =========================================
           2. HEADER SUPERIOR (FIJO)
           ========================================= */
        .client-header {
            position: fixed;
            top: 0; left: 0; width: 100%;
            height: 70px;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border-bottom: var(--border-neon);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 2rem;
            box-shadow: 0 4px 20px rgba(0, 255, 136, 0.05);
        }

        .logo-section {
            display: flex; align-items: center; gap: 1rem;
        }
        .logo-section img { height: 40px; filter: drop-shadow(0 0 5px var(--neon-green)); }
        
        .logo-text h1 {
            margin: 0; font-family: 'Montserrat', sans-serif;
            font-size: 1.2rem; font-weight: 700; color: #fff;
            text-transform: uppercase; letter-spacing: 1px;
        }
        .logo-text span {
            font-size: 0.7rem; color: var(--neon-green);
            letter-spacing: 2px; text-transform: uppercase;
        }

        .user-actions { display: flex; align-items: center; gap: 1.5rem; }

        .user-info { display: flex; align-items: center; gap: 12px; text-align: right; }
        .user-details strong { display: block; color: var(--neon-green); font-size: 0.9rem; }
        .user-details span { color: #888; font-size: 0.8rem; }

        .user-avatar {
            width: 38px; height: 38px;
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid var(--neon-green);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: var(--neon-green);
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.2);
        }

        .logout-btn {
            background: transparent; border: 1px solid #333;
            color: #666; padding: 0.5rem 1rem; border-radius: 20px;
            cursor: pointer; transition: 0.3s; display: flex; align-items: center; gap: 5px;
        }
        .logout-btn:hover {
            border-color: #ff4757; color: #ff4757; box-shadow: 0 0 10px rgba(255, 71, 87, 0.2);
        }

        /* =========================================
           3. SIDEBAR (MENÚ ESCRITORIO)
           ========================================= */
        .client-nav {
            position: fixed;
            top: 70px; left: 0; bottom: 0;
            width: 260px;
            background: var(--bg-panel);
            border-right: var(--border-neon);
            padding: 2rem 1.5rem;
            display: flex; flex-direction: column; gap: 0.8rem;
            overflow-y: auto;
            z-index: 900;
        }

        .nav-tab {
            display: flex; align-items: center; gap: 1rem;
            width: 100%; padding: 1rem;
            background: transparent;
            border: 1px solid transparent;
            color: var(--text-gray);
            font-family: 'Montserrat', sans-serif;
            font-size: 0.9rem; font-weight: 500;
            border-radius: 12px; cursor: pointer; transition: 0.3s;
            text-align: left;
        }

        .nav-tab i { font-size: 1.1rem; width: 20px; text-align: center; }

        .nav-tab:hover {
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
            transform: translateX(5px);
        }

        .nav-tab.active {
            background: rgba(0, 255, 136, 0.08);
            border: 1px solid var(--neon-green);
            color: var(--neon-green);
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.1) inset;
        }

        /* =========================================
           4. CONTENIDO PRINCIPAL
           ========================================= */
        .client-content {
            margin-left: 260px; /* Mismo ancho que sidebar */
            padding: 2rem 3rem;
            min-height: calc(100vh - 70px);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease;
        }
        .tab-content.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .tab-header {
            margin-bottom: 2rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 1rem;
            display: flex; align-items: center; justify-content: space-between;
        }
        
        .tab-header h2 {
            margin: 0; color: var(--neon-green);
            font-family: 'Montserrat', sans-serif; font-size: 1.8rem;
            text-transform: uppercase; letter-spacing: 1px;
            text-shadow: 0 0 10px rgba(0, 255, 136, 0.3);
        }

        /* =========================================
           5. GRID PRODUCTOS (CATÁLOGO)
           ========================================= */
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 2rem;
        }

        .product-card {
            background: var(--bg-panel);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 1.5rem;
            display: flex; flex-direction: column;
            transition: 0.3s;
            position: relative;
            overflow: hidden;
        }

        .product-card:hover {
            transform: translateY(-5px);
            border-color: var(--neon-green);
            box-shadow: 0 10px 30px rgba(0, 255, 136, 0.15);
        }

        .product-image {
            height: 180px;
            background: #000;
            border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            margin-bottom: 1.2rem;
            border: 1px solid rgba(255,255,255,0.05);
            overflow: hidden;
        }

        .product-image img {
            width: 100%; height: 100%; object-fit: cover;
            transition: 0.5s;
        }
        .product-card:hover .product-image img { transform: scale(1.1); }

        .product-image i { font-size: 3rem; color: #333; }

        .product-info h3 {
            font-size: 1.2rem; color: #fff; margin: 0 0 0.5rem 0; font-weight: 600;
        }
        
        .product-info p {
            color: #888; font-size: 0.9rem; line-height: 1.4; margin-bottom: 1rem;
        }

        .product-meta {
            margin-top: auto;
            display: flex; align-items: center; justify-content: space-between;
            border-top: 1px solid rgba(255,255,255,0.1);
            padding-top: 1rem;
        }

        .product-price {
            font-size: 1.4rem; font-weight: 700; color: var(--neon-green);
        }

        .btn-outline.sm {
            padding: 0.5rem 1.2rem;
            border: 1px solid var(--neon-green);
            background: transparent; color: var(--neon-green);
            border-radius: 8px; cursor: pointer; transition: 0.3s;
            font-weight: 600;
        }
        
        .btn-outline.sm:hover {
            background: var(--neon-green); color: #000;
            box-shadow: 0 0 15px var(--neon-green);
        }

        /* =========================================
           6. RESPONSIVE (MÓVIL)
           ========================================= */
        .mobile-menu-toggle { display: none; }
        .mobile-bottom-nav { display: none; }

        @media (max-width: 992px) {
            /* OCULTAR SIDEBAR ESCRITORIO */
            .client-nav { display: none; } 
            
            /* AJUSTE CONTENIDO */
            .client-content { 
                margin-left: 0; 
                padding: 1.5rem; 
                padding-bottom: 90px; /* Espacio para nav inferior */
            }
            
            /* HEADER MÓVIL */
            .client-header { padding: 0 1.5rem; }
            .user-info, .logout-btn { display: none; } /* Ocultar en header móvil */
            
            .mobile-menu-toggle {
                display: block;
                font-size: 1.5rem;
                color: var(--neon-green);
                cursor: pointer;
            }

            /* MOSTRAR NAV INFERIOR */
            .mobile-bottom-nav {
                display: flex;
                position: fixed; bottom: 0; left: 0; width: 100%;
                background: rgba(10, 10, 10, 0.98); /* Fondo casi sólido */
                border-top: var(--border-neon);
                justify-content: space-around;
                padding: 0.8rem 0;
                z-index: 2000;
                box-shadow: 0 -5px 20px rgba(0,0,0,0.8);
            }

            .mobile-nav-item {
                background: none; border: none;
                display: flex; flex-direction: column; align-items: center;
                gap: 5px; color: #666;
                font-size: 0.75rem; width: 25%;
                transition: 0.3s;
            }

            .mobile-nav-item i { font-size: 1.4rem; margin-bottom: 2px; }

            .mobile-nav-item.active {
                color: var(--neon-green);
            }
            .mobile-nav-item.active i {
                text-shadow: 0 0 10px var(--neon-green);
                transform: translateY(-3px);
            }

            /* Ajustes Grid en Móvil */
            .products-grid { grid-template-columns: 1fr; gap: 1.5rem; }
            
            /* Tarjeta horizontal en móvil (opcional, si te gusta como en app de delivery) */
            .product-card {
                flex-direction: row; align-items: center; gap: 1rem; padding: 1rem;
            }
            .product-image {
                width: 90px; height: 90px; margin-bottom: 0; flex-shrink: 0;
            }
            .product-info { text-align: left; }
            .product-info p { display: none; } /* Ocultar descrip larga */
            .product-meta { 
                border: none; padding: 0; margin: 0; 
                flex-direction: column; align-items: flex-end; gap: 10px;
            }
            .product-price { font-size: 1.1rem; }
        }

        /* =========================================
           7. AJUSTES CUENTA Y FORMULARIOS
           ========================================= */
        .settings-card {
            background: var(--bg-panel);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 16px; padding: 2rem;
            max-width: 600px; margin: 0 auto;
        }
        
        .form-group { margin-bottom: 1.2rem; }
        .form-group label { display: block; color: var(--neon-green); margin-bottom: 0.5rem; font-size: 0.9rem; }
        .form-group input {
            width: 100%; padding: 12px;
            background: #050505; border: 1px solid #333;
            border-radius: 8px; color: #fff; outline: none;
        }
        .form-group input:focus { border-color: var(--neon-green); }
        
        .btn-primary {
            width: 100%; padding: 12px;
            background: var(--neon-green); color: #000;
            font-weight: 700; border: none; border-radius: 8px;
            cursor: pointer; transition: 0.3s; text-transform: uppercase;
        }
        .btn-primary:hover { background: var(--neon-hover); box-shadow: 0 0 20px rgba(0,255,136,0.4); }

        /* Modales (mantenidos igual de funcionales) */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 3000;
            display: none; justify-content: center; align-items: center; padding: 1rem;
        }
        .modal-content {
            background: #151515; border: 1px solid var(--neon-green);
            border-radius: 20px; width: 100%; max-width: 500px;
            padding: 2rem; position: relative;
            box-shadow: 0 0 40px rgba(0,255,136,0.15);
        }
        .modal-close {
            position: absolute; top: 15px; right: 20px;
            background: none; border: none; color: #fff; font-size: 2rem; cursor: pointer;
        }
        .modal-main-image {
            width: 100%; height: 250px; object-fit: contain;
            background: #000; border-radius: 12px; border: 1px solid #333;
            margin-bottom: 1.5rem;
        }
    </style>
</head>

<body>

    <header class="client-header">
        <div class="logo-section">
            <img src="{% static 'img/logo.png' %}" alt="SIEER">
            <div class="logo-text">
                <h1>SIEER</h1>
                <span>Panel</span>
            </div>
        </div>
        
        <div class="user-actions">
            <div class="user-info">
                <div class="user-details">
                    <strong>{{ user.username }}</strong>
                    <span>Cliente</span>
                </div>
                <div class="user-avatar"><i class="fas fa-user"></i></div>
            </div>
            <form method="post" action="{% url 'logout' %}">
                {% csrf_token %}
                <button type="submit" class="logout-btn">
                    <i class="fas fa-sign-out-alt"></i> Salir
                </button>
            </form>
        </div>

        <div class="mobile-menu-toggle" id="mobileOptsBtn">
            <i class="fas fa-ellipsis-v"></i>
        </div>
    </header>

    <div class="client-container">
        
        <nav class="client-nav">
            <button class="nav-tab active" onclick="switchTab('productos')">
                <i class="fas fa-box-open"></i> Productos
            </button>
            <button class="nav-tab" onclick="switchTab('cotizaciones')">
                <i class="fas fa-comments"></i> Cotizaciones
            </button>
            <button class="nav-tab" onclick="switchTab('documentos')">
                <i class="fas fa-file-alt"></i> Documentos
            </button>
            <button class="nav-tab" onclick="switchTab('ajustes')">
                <i class="fas fa-user-cog"></i> Mi Cuenta
            </button>
        </nav>

        <main class="client-content">
            
            <div id="productos" class="tab-content active">
                <div class="tab-header"><h2>Catálogo</h2></div>
                <div class="products-grid">
                    {% if productos_disponibles %}
                        {% for producto in productos_disponibles %}
                        <div class="product-card">
                            <div class="product-image">
                                {% if producto.imagenes.first %}
                                    <img src="{{ producto.imagenes.first.imagen.url }}" alt="{{ producto.nombre }}">
                                {% else %}
                                    <i class="fas fa-box"></i>
                                {% endif %}
                            </div>
                            <div class="product-info">
                                <h3>{{ producto.nombre }}</h3>
                                <p>{{ producto.descripcion|truncatewords:12 }}</p>
                            </div>
                            <div class="product-meta">
                                <div class="product-price">${{ producto.precio|floatformat:0 }}</div>
                                <button class="btn-outline sm btn-ver-producto" 
                                    data-id="{{ producto.id }}"
                                    data-nombre="{{ producto.nombre }}"
                                    data-precio="${{ producto.precio|floatformat:0 }}"
                                    data-descripcion="{{ producto.descripcion }}"
                                    data-specs="{% if producto.potencia %}Potencia: {{producto.potencia}}{% endif %}"
                                    data-img="{% if producto.imagenes.first %}{{ producto.imagenes.first.imagen.url }}{% endif %}">
                                    Ver
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div style="text-align:center; padding:3rem; color:#666; grid-column:1/-1;">
                            <i class="fas fa-search" style="font-size:3rem; margin-bottom:1rem;"></i>
                            <p>No hay productos disponibles.</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <div id="cotizaciones" class="tab-content">
                <div class="tab-header"><h2>Mis Cotizaciones</h2></div>
                <iframe id="cotizaciones-iframe" src="{% url 'lista_chats_cotizacion' %}" 
                    style="width:100%; height:600px; border:none; border-radius:12px; background: rgba(255,255,255,0.02);">
                </iframe>
            </div>

            <div id="documentos" class="tab-content">
                <div class="tab-header"><h2>Documentos</h2></div>
                <div style="text-align:center; padding:5rem; border:2px dashed #333; border-radius:16px; color:#666;">
                    <i class="fas fa-folder-open" style="font-size:3rem; margin-bottom:1rem;"></i>
                    <p>No hay documentos disponibles.</p>
                </div>
            </div>

            <div id="ajustes" class="tab-content">
                <div class="tab-header"><h2>Configuración</h2></div>
                <div class="settings-card">
                    <form method="post">
                        {% csrf_token %}
                        <div class="form-group">
                            <label>Nombre</label>
                            {{ perfil_form.first_name }}
                        </div>
                        <div class="form-group">
                            <label>Apellido</label>
                            {{ perfil_form.last_name }}
                        </div>
                        <div class="form-group">
                            <label>Teléfono</label>
                            {{ perfil_form.telefono }}
                        </div>
                        <button type="submit" class="btn-primary">Guardar Cambios</button>
                    </form>
                    
                    <div style="margin-top:2rem; padding-top:1rem; border-top:1px solid #333; text-align:center;">
                        <a href="{% url 'password_change' %}" style="color:var(--neon-green); text-decoration:none; font-size:0.9rem;">
                            <i class="fas fa-lock"></i> Cambiar Contraseña
                        </a>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <div class="mobile-bottom-nav">
        <button class="mobile-nav-item active" onclick="switchTab('productos')">
            <i class="fas fa-home"></i> <span>Inicio</span>
        </button>
        <button class="mobile-nav-item" onclick="switchTab('cotizaciones')">
            <i class="fas fa-comments"></i> <span>Chats</span>
        </button>
        <button class="mobile-nav-item" onclick="switchTab('documentos')">
            <i class="fas fa-file-alt"></i> <span>Docs</span>
        </button>
        <button class="mobile-nav-item" onclick="switchTab('ajustes')">
            <i class="fas fa-user"></i> <span>Perfil</span>
        </button>
    </div>

    <div id="mobileOptsOverlay" style="display:none; position:fixed; top:70px; right:10px; background:#1a1a1a; border:1px solid var(--neon-green); padding:1rem; border-radius:12px; z-index:2000; box-shadow:0 5px 20px #000;">
        <form method="post" action="{% url 'logout' %}">
            {% csrf_token %}
            <button type="submit" style="background:none; border:none; color:#ff4757; font-size:1rem; display:flex; align-items:center; gap:10px;">
                <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
            </button>
        </form>
    </div>

    <div class="modal-overlay" id="productModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal()">&times;</button>
            <img id="modalImg" class="modal-main-image" src="" alt="">
            
            <h2 id="modalTitle" style="color:#fff; margin-bottom:0.5rem;"></h2>
            <p id="modalDesc" style="color:#bbb; margin-bottom:1rem; line-height:1.5;"></p>
            <p id="modalSpecs" style="color:var(--neon-green); font-weight:600; margin-bottom:2rem;"></p>
            
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <span id="modalPrice" style="font-size:1.8rem; font-weight:700; color:#fff;"></span>
                <button id="startChatBtn" class="btn-primary" style="width:auto; padding:10px 25px;">
                    <i class="fas fa-comment-dots"></i> Cotizar
                </button>
            </div>
        </div>
    </div>

    <div style="position:fixed; bottom:90px; right:20px; width:360px; height:550px; background:#121212; border:1px solid var(--neon-green); border-radius:16px; z-index:2500; display:none; flex-direction:column; box-shadow:0 10px 50px #000;" id="chatContainer">
        <div style="padding:1rem; background:#0a0a0a; border-bottom:1px solid #333; display:flex; justify-content:space-between; align-items:center; border-radius:16px 16px 0 0;">
            <h3 style="margin:0; color:#fff; font-size:1rem;">Chat de Cotización</h3>
            <button onclick="closeChat()" style="background:none; border:none; color:#666; font-size:1.2rem; cursor:pointer;"><i class="fas fa-times"></i></button>
        </div>
        <div style="flex:1; overflow:hidden;">
            <iframe id="chatFrame" src="" style="width:100%; height:100%; border:none;"></iframe>
        </div>
    </div>

    <script>
        // === LÓGICA DE NAVEGACIÓN (Sin Cambios Funcionales) ===
        function switchTab(tabId) {
            // 1. Ocultar todos los contenidos
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            
            // 2. Desactivar botones (Escritorio y Móvil)
            document.querySelectorAll('.nav-tab, .mobile-nav-item').forEach(btn => btn.classList.remove('active'));
            
            // 3. Mostrar contenido seleccionado
            document.getElementById(tabId).classList.add('active');
            
            // 4. Activar botón correspondiente (buscando por el onclick)
            const activeBtns = document.querySelectorAll(`[onclick="switchTab('${tabId}')"]`);
            activeBtns.forEach(btn => btn.classList.add('active'));

            // Scroll arriba
            window.scrollTo(0, 0);
        }

        // === Menú Opciones Móvil ===
        const mobileOptsBtn = document.getElementById('mobileOptsBtn');
        const mobileOptsOverlay = document.getElementById('mobileOptsOverlay');
        if(mobileOptsBtn) {
            mobileOptsBtn.addEventListener('click', () => {
                mobileOptsOverlay.style.display = mobileOptsOverlay.style.display === 'none' ? 'block' : 'none';
            });
        }

        // === MODAL PRODUCTO ===
        const modalOverlay = document.getElementById('productModal');
        let currentProductId = null;

        document.querySelectorAll('.btn-ver-producto').forEach(btn => {
            btn.addEventListener('click', () => {
                currentProductId = btn.dataset.id;
                
                // Llenar datos
                document.getElementById('modalTitle').textContent = btn.dataset.nombre;
                document.getElementById('modalPrice').textContent = btn.dataset.precio;
                document.getElementById('modalDesc').textContent = btn.dataset.descripcion;
                document.getElementById('modalSpecs').textContent = btn.dataset.specs;
                
                const img = btn.dataset.img || "{% static 'img/placeholder.png' %}";
                document.getElementById('modalImg').src = img;
                
                modalOverlay.style.display = 'flex';
            });
        });

        function closeModal() {
            modalOverlay.style.display = 'none';
        }

        // === LÓGICA DE CHAT (Intacta) ===
        const startChatBtn = document.getElementById('startChatBtn');
        const chatContainer = document.getElementById('chatContainer');
        const chatFrame = document.getElementById('chatFrame');

        startChatBtn.addEventListener('click', async () => {
            if(!currentProductId) return;
            
            try {
                const res = await fetch(`/iniciar-chat-cotizacion/${currentProductId}/`);
                const data = await res.json();
                
                if(data.status === 'ok') {
                    closeModal(); // Cerrar modal producto
                    openChat(data.chat_id); // Abrir chat
                    
                    // Recargar lista de cotizaciones en background
                    const listFrame = document.getElementById('cotizaciones-iframe');
                    listFrame.src = listFrame.src; 
                    
                    // Cambiar a tab de cotizaciones
                    switchTab('cotizaciones');
                } else {
                    alert('Error al iniciar chat');
                }
            } catch(e) {
                console.error(e);
                alert('Error de conexión');
            }
        });

        function openChat(chatId) {
            chatFrame.src = `/chat-cotizacion/${chatId}/`;
            chatContainer.style.display = 'flex';
        }

        function closeChat() {
            chatContainer.style.display = 'none';
            chatFrame.src = 'about:blank';
        }

        // Escuchar mensajes del iframe (Lista de chats)
        window.addEventListener('message', (e) => {
            if(e.data && e.data.type === 'OPEN_CHAT_MODAL') {
                openChat(e.data.chatId);
                // En móvil, si abren un chat, cambiar tab
                if(window.innerWidth < 992) switchTab('cotizaciones');
            }
        });
    </script>
</body>
</html>
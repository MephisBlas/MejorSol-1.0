{% extends 'base.html' %}
{% load static %}

{% block title %}Registro - SIEER Chile{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/registro.css' %}">
<style>
    /* =========================================
       1. CONFIGURACIÓN GENERAL Y COLORES
       ========================================= */
    :root {
        /* El verde exacto del Login que te gustó */
        --sieer-green: #00ff88; 
        --sieer-green-hover: #00cc6a;
        --error-red: #ff4d4d; /* Rojo brillante para errores */
        --bg-card: rgba(18, 18, 18, 0.98);
    }

    .registro-page {
        background-color: #050505;
        overflow-x: hidden;
    }

    .register-container {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 110px 20px 50px; /* Espacio para header */
        position: relative;
    }

    /* Partículas */
    .floating-particles {
        position: absolute;
        top: 0; left: 0; width: 100%; height: 100%;
        pointer-events: none;
        z-index: 0;
    }
    .particle {
        position: absolute;
        background: var(--sieer-green);
        border-radius: 50%;
        opacity: 0.15;
    }

    /* =========================================
       2. TARJETA WIZARD
       ========================================= */
    .register-card {
        background: var(--bg-card);
        border: 1px solid rgba(0, 255, 136, 0.2);
        border-radius: 24px;
        padding: 2.5rem;
        width: 100%;
        max-width: 500px;
        box-shadow: 0 25px 60px rgba(0, 0, 0, 0.9);
        position: relative;
        z-index: 1;
        overflow: hidden;
    }

    .register-card h2 {
        color: #ffffff;
        font-family: var(--font-title);
        font-size: 1.8rem;
        text-align: center;
        margin-bottom: 0.5rem;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .subtitle {
        text-align: center;
        color: #b0b0b0;
        font-size: 0.95rem;
        margin-bottom: 2rem;
    }

    /* =========================================
       3. BARRA DE PROGRESO
       ========================================= */
    .progress-container {
        display: flex;
        justify-content: space-between;
        margin-bottom: 2.5rem;
        position: relative;
        padding: 0 10px;
    }

    .progress-bg {
        position: absolute;
        top: 50%; left: 10px; right: 10px; height: 3px;
        background: #333;
        z-index: 0;
        transform: translateY(-50%);
        border-radius: 3px;
    }

    .progress-bar {
        position: absolute;
        top: 50%; left: 10px; height: 3px;
        background: var(--sieer-green);
        z-index: 1;
        transform: translateY(-50%);
        width: 0%;
        transition: width 0.4s ease;
        border-radius: 3px;
        box-shadow: 0 0 10px var(--sieer-green);
    }

    .step-indicator {
        width: 32px; height: 32px;
        background: #1a1a1a;
        border: 2px solid #444;
        border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        font-size: 0.85rem; color: #888;
        font-weight: bold;
        z-index: 2;
        transition: all 0.4s ease;
    }

    .step-indicator.active {
        border-color: var(--sieer-green);
        color: var(--sieer-green);
        background: #000;
        box-shadow: 0 0 15px rgba(0, 255, 136, 0.3);
        transform: scale(1.1);
    }

    .step-indicator.completed {
        background: var(--sieer-green);
        border-color: var(--sieer-green);
        color: #000;
    }

    /* =========================================
       4. FORMULARIO E INPUTS
       ========================================= */
    .form-step {
        display: none;
        animation: slideInRight 0.4s ease;
    }
    .form-step.active { display: block; }

    @keyframes slideInRight {
        from { opacity: 0; transform: translateX(30px); }
        to { opacity: 1; transform: translateX(0); }
    }

    .form-group { margin-bottom: 1.5rem; }

    .form-group label {
        display: block;
        color: #ffffff;
        margin-bottom: 0.6rem;
        font-size: 0.9rem;
        font-weight: 600;
    }

    .form-input-wrapper { position: relative; }

    .form-input-wrapper input {
        width: 100%;
        padding: 14px 15px 14px 45px; /* Espacio para icono */
        background: #0a0a0a;
        border: 1px solid #333;
        border-radius: 12px;
        color: #fff;
        font-size: 1rem;
        transition: all 0.3s ease;
        outline: none;
        font-family: var(--font-body);
    }

    /* Focus Verde Neón (Igual al Login) */
    .form-input-wrapper input:focus {
        border-color: var(--sieer-green);
        box-shadow: 0 0 0 3px rgba(0, 255, 136, 0.15);
        background: #0f0f0f;
    }

    .input-icon {
        position: absolute;
        left: 15px; top: 50%;
        transform: translateY(-50%);
        color: #666;
        font-size: 1.1rem;
        transition: 0.3s;
    }

    .form-input-wrapper input:focus + .input-icon {
        color: var(--sieer-green);
    }

    /* =========================================
       5. ERRORES (CORREGIDOS Y VISIBLES)
       ========================================= */
    /* Estilo para errores que vienen del backend (Django) */
    .error-list {
        list-style: none;
        padding: 0;
        margin: 5px 0 0 0;
    }

    /* Estilo unificado de mensaje de error */
    .error-message, .error-list li {
        background-color: rgba(255, 77, 77, 0.1); /* Fondo rojo transparente */
        color: var(--error-red) !important; /* Texto Rojo Brillante FORZADO */
        border: 1px solid var(--error-red);
        padding: 10px;
        border-radius: 8px;
        font-size: 0.85rem;
        font-weight: 600; /* Negrita para leer mejor */
        margin-top: 8px;
        display: flex;
        align-items: center;
        gap: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    /* Error global arriba del form */
    .global-alert {
        background: rgba(255, 77, 77, 0.15);
        border-left: 4px solid var(--error-red);
        color: #fff;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1.5rem;
        font-size: 0.9rem;
    }

    /* Input con error */
    input.input-error {
        border-color: var(--error-red) !important;
        background-color: rgba(255, 77, 77, 0.05) !important;
    }
    
    /* Animación de sacudida para errores */
    .shake {
        animation: shake 0.4s ease-in-out;
    }
    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-5px); }
        75% { transform: translateX(5px); }
    }

    /* =========================================
       6. BOTONES DE NAVEGACIÓN
       ========================================= */
    .form-navigation {
        display: flex;
        gap: 1rem;
        margin-top: 2.5rem;
    }

    .btn-prev {
        flex: 1;
        background: transparent;
        border: 1px solid #444;
        color: #ccc;
        padding: 14px;
        border-radius: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: 0.3s;
    }
    .btn-prev:hover {
        border-color: #fff;
        color: #fff;
        background: rgba(255,255,255,0.05);
    }
    .btn-prev:disabled {
        opacity: 0; 
        pointer-events: none;
    }

    .btn-next, .btn-submit {
        flex: 2;
        background: var(--sieer-green); /* VERDE LOGIN */
        color: #000; /* Texto negro */
        border: none;
        padding: 14px;
        border-radius: 12px;
        font-weight: 700;
        font-size: 1rem;
        cursor: pointer;
        transition: 0.3s;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        box-shadow: 0 4px 15px rgba(0, 255, 136, 0.2);
    }

    .btn-next:hover, .btn-submit:hover {
        background: var(--sieer-green-hover);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 255, 136, 0.4);
    }

    /* Footer link */
    .register-footer {
        text-align: center;
        margin-top: 2rem;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        padding-top: 1.5rem;
        font-size: 0.9rem;
        color: #888;
    }
    .register-footer a {
        color: var(--sieer-green);
        font-weight: 600;
        text-decoration: none;
    }
    .register-footer a:hover { text-decoration: underline; }
</style>
{% endblock %}

{% block content %}
<body class="registro-page">
    <div class="register-container">
        <div class="floating-particles" id="particles"></div>

        <div class="register-card">
            <h2>Crear Cuenta</h2>
            <p class="subtitle">Complete sus datos paso a paso</p>

            <div class="progress-container">
                <div class="progress-bg"></div>
                <div class="progress-bar" id="progressBar"></div>
                <div class="step-indicator active">1</div>
                <div class="step-indicator">2</div>
                <div class="step-indicator">3</div>
                <div class="step-indicator">4</div>
            </div>

            {% if form.errors %}
            <div class="global-alert">
                <i class="fas fa-exclamation-triangle"></i>
                <strong>Hubo un problema:</strong> Por favor revisa los campos marcados en rojo.
            </div>
            {% endif %}

            <form method="post" id="multiStepForm" novalidate>
                {% csrf_token %}

                <div class="form-step active" data-step="1">
                    <div class="form-group">
                        <label>Nombre</label>
                        <div class="form-input-wrapper">
                            {{ form.first_name }}
                            <i class="fas fa-user input-icon"></i>
                        </div>
                        {% if form.first_name.errors %}
                            <div class="error-message">{{ form.first_name.errors.0 }}</div>
                        {% endif %}
                    </div>
                    <div class="form-group">
                        <label>Apellido</label>
                        <div class="form-input-wrapper">
                            {{ form.last_name }}
                            <i class="fas fa-user-tag input-icon"></i>
                        </div>
                        {% if form.last_name.errors %}
                            <div class="error-message">{{ form.last_name.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>

                <div class="form-step" data-step="2">
                    <div class="form-group">
                        <label>Nombre de Usuario</label>
                        <div class="form-input-wrapper">
                            {{ form.username }}
                            <i class="fas fa-id-card input-icon"></i>
                        </div>
                        <small style="color:#999; font-size:0.75rem; margin-top:5px; display:block;">
                            Solo letras, números y @/./+/-/_
                        </small>
                        {% if form.username.errors %}
                            <div class="error-message">{{ form.username.errors.0 }}</div>
                        {% endif %}
                    </div>
                    <div class="form-group">
                        <label>Correo Electrónico</label>
                        <div class="form-input-wrapper">
                            {{ form.email }}
                            <i class="fas fa-envelope input-icon"></i>
                        </div>
                        {% if form.email.errors %}
                            <div class="error-message">{{ form.email.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>

                <div class="form-step" data-step="3">
                    <div class="form-group">
                        <label>Contraseña</label>
                        <div class="form-input-wrapper">
                            {{ form.password1 }}
                            <i class="fas fa-lock input-icon"></i>
                        </div>
                        {% if form.password1.errors %}
                            <div class="error-message">{{ form.password1.errors.0 }}</div>
                        {% endif %}
                    </div>
                    <div class="form-group">
                        <label>Confirmar Contraseña</label>
                        <div class="form-input-wrapper">
                            {{ form.password2 }}
                            <i class="fas fa-lock input-icon"></i>
                        </div>
                        {% if form.password2.errors %}
                            <div class="error-message">{{ form.password2.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>

                <div class="form-step" data-step="4">
                    <div class="form-group">
                        <label>Teléfono</label>
                        <div class="form-input-wrapper">
                            {{ form.telefono }}
                            <i class="fas fa-phone input-icon"></i>
                        </div>
                        {% if form.telefono.errors %}
                            <div class="error-message">{{ form.telefono.errors.0 }}</div>
                        {% endif %}
                    </div>
                    <div class="form-group">
                        <label>Dirección</label>
                        <div class="form-input-wrapper">
                            {{ form.direccion }}
                            <i class="fas fa-map-marker-alt input-icon"></i>
                        </div>
                        {% if form.direccion.errors %}
                            <div class="error-message">{{ form.direccion.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>

                <div class="form-navigation">
                    <button type="button" class="btn-prev" id="prevBtn" disabled>
                        Atrás
                    </button>
                    <button type="button" class="btn-next" id="nextBtn">
                        Siguiente
                    </button>
                    <button type="submit" class="btn-submit" id="submitBtn" style="display: none;">
                        Finalizar Registro
                    </button>
                </div>
            </form>

            <div class="register-footer">
                ¿Ya tienes cuenta? <a href="{% url 'login' %}">Inicia sesión aquí</a>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const steps = document.querySelectorAll('.form-step');
            const indicators = document.querySelectorAll('.step-indicator');
            const progressBar = document.getElementById('progressBar');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const submitBtn = document.getElementById('submitBtn');
            let currentStep = 0;

            // --- 1. VALIDACIÓN VISUAL ---
            function validateCurrentStep() {
                const currentStepEl = steps[currentStep];
                const inputs = currentStepEl.querySelectorAll('input[required]');
                let isValid = true;

                inputs.forEach(input => {
                    // Limpiar error previo
                    input.classList.remove('input-error');
                    
                    // Validar vacío
                    if (!input.value.trim()) {
                        isValid = false;
                        input.classList.add('input-error');
                        // Animación de sacudida
                        input.parentElement.classList.add('shake');
                        setTimeout(() => input.parentElement.classList.remove('shake'), 400);
                    }
                    
                    // Validación extra simple de email
                    if (input.type === 'email' && input.value.trim()) {
                        if (!input.value.includes('@')) {
                            isValid = false;
                            input.classList.add('input-error');
                        }
                    }
                });

                return isValid;
            }

            // --- 2. NAVEGACIÓN DEL WIZARD ---
            function updateUI() {
                // Mostrar paso actual
                steps.forEach((step, idx) => {
                    if(idx === currentStep) {
                        step.classList.add('active');
                    } else {
                        step.classList.remove('active');
                    }
                });

                // Actualizar indicadores
                indicators.forEach((ind, idx) => {
                    ind.classList.remove('active', 'completed');
                    ind.innerHTML = idx + 1; // Reset número

                    if(idx < currentStep) {
                        ind.classList.add('completed');
                        ind.innerHTML = '<i class="fas fa-check"></i>';
                    } else if(idx === currentStep) {
                        ind.classList.add('active');
                    }
                });

                // Actualizar Barra
                const progress = (currentStep / (steps.length - 1)) * 100;
                progressBar.style.width = `${progress}%`;

                // Botones
                prevBtn.disabled = currentStep === 0;
                if (currentStep === steps.length - 1) {
                    nextBtn.style.display = 'none';
                    submitBtn.style.display = 'block';
                } else {
                    nextBtn.style.display = 'block';
                    submitBtn.style.display = 'none';
                }
            }

            nextBtn.addEventListener('click', () => {
                if(validateCurrentStep()) {
                    currentStep++;
                    updateUI();
                }
            });

            prevBtn.addEventListener('click', () => {
                currentStep--;
                updateUI();
            });

            // --- 3. INPUTS PLACEHOLDERS ---
            const inputs = document.querySelectorAll('input');
            inputs.forEach(input => {
                // Limpiar error al escribir
                input.addEventListener('input', () => {
                    input.classList.remove('input-error');
                });

                if (!input.placeholder) {
                    if (input.name === 'first_name') input.placeholder = 'Ej: Juan';
                    if (input.name === 'last_name') input.placeholder = 'Ej: Pérez';
                    if (input.name === 'username') input.placeholder = 'Ej: juanperez2025';
                    if (input.name === 'email') input.placeholder = 'nombre@ejemplo.com';
                    if (input.name.includes('password')) input.placeholder = 'Mínimo 8 caracteres';
                    if (input.name === 'telefono') input.placeholder = '+56 9 1234 5678';
                    if (input.name === 'direccion') input.placeholder = 'Calle, Número, Comuna';
                }
            });

            // --- 4. PARTÍCULAS ---
            const pContainer = document.getElementById('particles');
            for(let i=0; i<20; i++){
                let p = document.createElement('div');
                p.className = 'particle';
                let size = Math.random() * 6 + 2;
                p.style.width = size + 'px';
                p.style.height = size + 'px';
                p.style.left = Math.random() * 100 + '%';
                p.style.top = Math.random() * 100 + '%';
                pContainer.appendChild(p);
            }
        });
    </script>
</body>
{% endblock %}
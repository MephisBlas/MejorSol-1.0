{% load static %}
{% load humanize %}

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Reportes BI & IA - SIEER Chile</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* ===================== 1. BASE ===================== */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
        --bg-body: #050505; 
        --bg-panel: #0f0f0f; /* Restaurado al tono original del panel */
        --bg-card: rgba(20, 20, 20, 0.6);
        --neon-green: #00ff88; 
        --neon-blue: #00ccff; 
        --neon-purple: #a855f7;
        --text-main: #ffffff; 
        --text-muted: #b0b0b0; /* Restaurado */
        --border-neon: 1px solid rgba(0, 255, 136, 0.2); /* Restaurado */
        --border-light: 1px solid rgba(255, 255, 255, 0.08);
    }
    html, body { width: 100%; height: 100%; background-color: var(--bg-body); font-family: 'Roboto', sans-serif; color: var(--text-main); overflow: hidden; }
    .admin-container { display: flex; width: 100vw; height: 100vh; }

    /* ===================== 2. SIDEBAR (DISEÑO ORIGINAL RESTAURADO) ===================== */
    .admin-sidebar { 
        width: 280px; height: 100%; 
        background: var(--bg-panel); 
        border-right: var(--border-neon); /* Borde verde sutil */
        display: flex; flex-direction: column; flex-shrink: 0; z-index: 1000; transition: 0.3s; 
    }
    .sidebar-header { padding: 1.5rem; border-bottom: 1px solid rgba(255,255,255,0.05); }
    .admin-logo { display: flex; align-items: center; gap: 1rem; }
    .admin-logo img { height: 45px; filter: drop-shadow(0 0 5px rgba(0,255,136,0.4)); }
    .logo-text h2 { margin: 0; color: #fff; font-size: 1.3rem; font-family: 'Montserrat', sans-serif; text-transform: uppercase; }
    .logo-text span { color: var(--neon-green); font-size: 0.75rem; letter-spacing: 1px; }

    .sidebar-nav { flex: 1; overflow-y: auto; padding: 1rem; }
    .nav-section h3 { color: #666; font-size: 0.8rem; text-transform: uppercase; margin: 1.5rem 0 0.5rem 0.5rem; letter-spacing: 1px; }
    
    .nav-item { list-style: none; margin-bottom: 0.5rem; }
    .nav-item a { 
        display: flex; align-items: center; gap: 12px; padding: 12px 15px; 
        color: #b0b0b0; text-decoration: none; border-radius: 8px; 
        transition: 0.3s; font-size: 0.95rem; font-weight: 500; 
        border-left: 3px solid transparent; /* Preparado para el efecto */
    }
    /* Efecto Hover y Activo ORIGINAL */
    .nav-item a:hover, .nav-item.active a { 
        background: rgba(0, 255, 136, 0.08); 
        color: var(--neon-green); 
    }
    .nav-item.active a { 
        border-left: 3px solid var(--neon-green); /* La línea verde a la izquierda de tu foto */
        font-weight: 600;
    }
    .nav-item a i { width: 20px; text-align: center; }

    .sidebar-footer { padding: 1.5rem; border-top: 1px solid rgba(255,255,255,0.05); }
    .user-info { display: flex; gap: 10px; align-items: center; margin-bottom: 1rem; }
    .user-avatar { 
        width: 40px; height: 40px; background: var(--neon-green); color: #000; 
        border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; 
    }
    .user-details strong { color: #fff; display: block; font-size: 0.9rem; }
    .user-details span { color: #666; font-size: 0.8rem; }
    
    .logout-btn { 
        width: 100%; padding: 12px; background: rgba(255, 71, 87, 0.1); color: #ff4757; 
        border: 1px solid rgba(255, 71, 87, 0.3); border-radius: 8px; cursor: pointer; transition: 0.3s; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px; 
    }
    .logout-btn:hover { background: #ff4757; color: #fff; box-shadow: 0 0 10px rgba(255, 71, 87, 0.4); }

    /* ===================== 3. MAIN CONTENT ===================== */
    .admin-main { flex-grow: 1; height: 100vh; display: flex; flex-direction: column; overflow-y: auto; background-image: radial-gradient(circle at 50% 0%, #1a1a1a 0%, #050505 50%); }
    
    .admin-header { 
        padding: 1rem 2rem; background: rgba(15, 15, 15, 0.9); backdrop-filter: blur(10px); 
        border-bottom: var(--border-neon); display: flex; justify-content: space-between; align-items: center; 
        position: sticky; top: 0; z-index: 500; 
    }
    .admin-header h1 { font-family: 'Montserrat', sans-serif; font-size: 1.5rem; font-weight: 700; margin: 0; color: #fff; }

    /* LAYOUT PRINCIPAL */
    .admin-content { padding: 2rem; padding-bottom: 5rem; display: flex; flex-direction: column; gap: 2rem; }

    /* --- SECCIÓN A: FILTROS --- */
    .filter-container { 
        background: var(--bg-card); backdrop-filter: blur(10px); border: var(--border-light); 
        border-radius: 12px; padding: 1rem 1.5rem; display: flex; align-items: center; gap: 1.5rem;
    }
    .filter-container h2 { color: var(--neon-green); font-size: 1.1rem; margin-right: auto; display: flex; align-items: center; gap: 8px; margin: 0; font-family:'Montserrat', sans-serif; }
    .filter-inputs { display: flex; gap: 10px; }
    .filter-input { 
        background: #0a0a0a; border: 1px solid #333; color: #fff; 
        padding: 8px 12px; border-radius: 6px; color-scheme: dark; font-family: inherit; 
    }
    .btn-filter { 
        background: var(--neon-green); color: #000; border: none; 
        padding: 8px 20px; border-radius: 6px; font-weight: 700; cursor: pointer; transition: 0.2s; 
    }
    .btn-filter:hover { background: #00cc6a; transform: scale(1.05); }

    /* --- SECCIÓN B: KPIs (GRID FLUIDO) --- */
    .stats-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
        gap: 1.5rem;
    }

    .kpi-card { 
        background: var(--bg-card); backdrop-filter: blur(5px); border: var(--border-light); 
        border-radius: 16px; padding: 1.5rem; display: flex; flex-direction: column; justify-content: center; 
        transition: 0.3s; position: relative; overflow: hidden;
    }
    .kpi-card:hover { transform: translateY(-5px); border-color: var(--neon-green); box-shadow: 0 5px 15px rgba(0,255,136,0.1); }
    
    .kpi-label { font-size: 0.8rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 0.5rem; font-weight: 600; }
    .kpi-value { font-family: 'Montserrat', sans-serif; font-size: 2rem; font-weight: 800; color: #fff; }
    .kpi-value small { font-size: 1rem; color: var(--neon-green); font-weight: 600; margin-left: 5px; }

    /* ESTILO ESPECIAL PARA KPI DE IA (MORADO) */
    .kpi-ai {
        border: 1px solid rgba(168, 85, 247, 0.4);
        background: linear-gradient(135deg, rgba(168, 85, 247, 0.05) 0%, rgba(20,20,20,0.8) 100%);
        box-shadow: 0 0 15px rgba(168, 85, 247, 0.1);
    }
    .kpi-ai:hover { border-color: var(--neon-purple); box-shadow: 0 0 25px rgba(168, 85, 247, 0.3); }
    .kpi-ai .kpi-value { color: var(--neon-purple); text-shadow: 0 0 10px rgba(168, 85, 247, 0.5); }
    .kpi-ai .kpi-icon { position: absolute; top: 15px; right: 15px; font-size: 1.2rem; color: var(--neon-purple); opacity: 0.5; }

    /* --- SECCIÓN C: GRÁFICOS (GRID COMPLEJO) --- */
    .charts-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr); /* 2 Columnas base */
        gap: 1.5rem;
    }

    .chart-card {
        background: var(--bg-card); border: var(--border-light); border-radius: 16px;
        padding: 1.5rem; min-height: 350px; display: flex; flex-direction: column;
        box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }
    .chart-header { 
        display: flex; justify-content: space-between; align-items: center; 
        margin-bottom: 1rem; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 10px; 
    }
    .chart-header h3 { font-size: 1rem; font-weight: 700; color: #fff; font-family: 'Montserrat', sans-serif; text-transform: uppercase; letter-spacing: 0.5px; margin: 0; }
    .chart-body { flex: 1; position: relative; width: 100%; }

    /* Estilos específicos de gráficos */
    .chart-prediccion { border-color: rgba(0, 204, 255, 0.3); }
    .chart-prediccion h3 { color: var(--neon-blue); display: flex; align-items: center; gap: 8px; }
    
    .chart-clientes { border-color: rgba(168, 85, 247, 0.3); }
    .chart-clientes h3 { color: var(--neon-purple); display: flex; align-items: center; gap: 8px; }

    /* Span completo para gráficos grandes si se desea */
    .col-span-2 { grid-column: span 2; }

    /* ===================== 4. RESPONSIVE ===================== */
    @media (max-width: 1200px) {
        .charts-grid { grid-template-columns: 1fr; } /* 1 Columna en tablets */
        .col-span-2 { grid-column: span 1; }
    }
    @media (max-width: 768px) {
        .admin-sidebar { display: none; }
        .filter-container { flex-direction: column; align-items: stretch; }
        .filter-inputs { flex-direction: column; }
        .admin-content { padding: 1rem; }
        .kpi-value { font-size: 1.8rem; }
    }
  </style>
</head>

<body>
<div class="admin-container">
    <aside class="admin-sidebar">
        <div class="sidebar-header">
            <div class="admin-logo">
                <img src="{% static 'img/logo.png' %}" alt="SIEER">
                <div class="logo-text"><h2>SIEER</h2><span>Admin Panel</span></div>
            </div>
        </div>
        <nav class="sidebar-nav">
            <div class="nav-section">
                <h3>Gestión</h3>
                <ul>
                    <li class="nav-item"><a href="{% url 'admin_panel' %}"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
                    <li class="nav-item"><a href="{% url 'calculos_estadisticas' %}"><i class="fas fa-calculator"></i> Cálculos</a></li>
                    <li class="nav-item"><a href="{% url 'cotizaciones' %}"><i class="fas fa-file-invoice-dollar"></i> Cotizaciones</a></li>
                    <li class="nav-item"><a href="{% url 'control_inventario' %}"><i class="fas fa-boxes"></i> Inventario</a></li>
                </ul>
            </div>
            <div class="nav-section">
                <h3>Inteligencia Artificial</h3>
                <ul>
                    <li class="nav-item active"><a href="{% url 'reportes_graficos' %}"><i class="fas fa-chart-pie"></i> Reportes BI</a></li>
                    <li class="nav-item"><a href="{% url 'historial_cotizaciones' %}"><i class="fas fa-history"></i> Historial</a></li>
                </ul>
            </div>
            <div class="nav-section">
                <h3>Sistema</h3>
                <ul>
                    <li class="nav-item"><a href="{% url 'cuenta' %}"><i class="fas fa-user-circle"></i> Cuenta</a></li>
                    <li class="nav-item"><a href="{% url 'configuracion' %}"><i class="fas fa-cog"></i> Configuración</a></li>
                </ul>
            </div>
        </nav>
        <div class="sidebar-footer">
            <div class="user-info">
                <div class="user-avatar"><i class="fas fa-user-shield"></i></div>
                <div class="user-details"><strong>{{ user.username }}</strong><span>Administrador</span></div>
            </div>
            <form method="post" action="{% url 'logout' %}">{% csrf_token %}
                <button type="submit" class="logout-btn"><i class="fas fa-sign-out-alt"></i> Cerrar Sesión</button>
            </form>
        </div>
    </aside>

    <main class="admin-main">
        <header class="admin-header">
            <h1>Analítica de Negocio & IA</h1>
        </header>

        <div class="admin-content">
            <div class="filter-container">
                <h2><i class="fas fa-filter"></i> Rango de Datos</h2>
                <form method="GET" class="filter-inputs" style="flex-grow:1; display:flex; gap:10px; justify-content:flex-end;">
                    <input type="date" name="desde" class="filter-input" value="{{ desde|default:'' }}" title="Fecha Inicio">
                    <input type="date" name="hasta" class="filter-input" value="{{ hasta|default:'' }}" title="Fecha Fin">
                    <button type="submit" class="btn-filter">Actualizar</button>
                </form>
            </div>

            <div class="stats-container">
                <div class="kpi-card">
                    <span class="kpi-label">Tasa Conversión</span>
                    <div class="kpi-value">{{ kpi_tasa_conversion|floatformat:1 }}<small>%</small></div>
                </div>
                <div class="kpi-card">
                    <span class="kpi-label">Cotizaciones Totales</span>
                    <div class="kpi-value">{{ kpi_total_cotizaciones|intcomma }}</div>
                </div>
                <div class="kpi-card">
                    <span class="kpi-label">Promedio Diario</span>
                    <div class="kpi-value">{{ kpi_promedio_cot_dia|floatformat:1 }}</div>
                </div>
                <div class="kpi-card">
                    <span class="kpi-label">Ventas Aprobadas</span>
                    <div class="kpi-value" style="color:var(--neon-green)">{{ kpi_aprobadas|intcomma }}</div>
                </div>
                
                <div class="kpi-card kpi-ai">
                    <i class="fas fa-users kpi-icon"></i>
                    <span class="kpi-label" style="color:rgba(255,255,255,0.8)">Proy. Clientes (7d)</span>
                    <div class="kpi-value">+{{ kpi_proyeccion_clientes }}</div>
                </div>
            </div>

            <div class="charts-grid">
                
                <div class="chart-card">
                    <div class="chart-header"><h3>Cotizaciones (Histórico)</h3></div>
                    <div class="chart-body"><canvas id="tendenciaChart"></canvas></div>
                </div>

                <div class="chart-card chart-prediccion">
                    <div class="chart-header"><h3><i class="fas fa-robot"></i> IA: Demanda Futura</h3></div>
                    <div class="chart-body"><canvas id="prediccionChart"></canvas></div>
                </div>

                <div class="chart-card chart-clientes">
                    <div class="chart-header"><h3><i class="fas fa-user-plus"></i> IA: Crecimiento Clientes</h3></div>
                    <div class="chart-body"><canvas id="clientesChart"></canvas></div>
                </div>

                <div class="chart-card">
                    <div class="chart-header"><h3>Estado Actual</h3></div>
                    <div class="chart-body"><canvas id="embudoChart"></canvas></div>
                </div>

                <div class="chart-card col-span-2">
                    <div class="chart-header"><h3>Top Productos Solicitados</h3></div>
                    <div class="chart-body"><canvas id="productosChart"></canvas></div>
                </div>
            </div>

        </div>
    </main>
</div>

<script id="d-embudo-l" type="application/json">{{ embudo_labels|safe }}</script>
<script id="d-embudo-v" type="application/json">{{ embudo_valores|safe }}</script>
<script id="d-tend-l" type="application/json">{{ tendencia_labels|safe }}</script>
<script id="d-tend-v" type="application/json">{{ tendencia_valores|safe }}</script>
<script id="d-prod-l" type="application/json">{{ productos_labels|safe }}</script>
<script id="d-prod-v" type="application/json">{{ productos_valores|safe }}</script>
<script id="d-pred-l" type="application/json">{{ prediccion_labels|safe }}</script>
<script id="d-pred-v" type="application/json">{{ prediccion_valores|safe }}</script>
<script id="d-cli-l" type="application/json">{{ clientes_ml_labels|safe }}</script>
<script id="d-cli-v" type="application/json">{{ clientes_ml_valores|safe }}</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        Chart.defaults.color = '#888';
        Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.05)';
        Chart.defaults.font.family = "'Roboto', sans-serif";
        
        function getD(id) { try { return JSON.parse(document.getElementById(id).textContent); } catch(e){ return []; } }

        // 1. TENDENCIA
        new Chart(document.getElementById('tendenciaChart'), {
            type: 'line',
            data: {
                labels: getD('d-tend-l'),
                datasets: [{ label: 'Reales', data: getD('d-tend-v'), borderColor: '#00ff88', backgroundColor: 'rgba(0,255,136,0.1)', fill: true, tension: 0.4, pointRadius: 3 }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });

        // 2. PREDICCIÓN COTIZACIONES
        const pV = getD('d-pred-v');
        if(pV.length > 0) {
            new Chart(document.getElementById('prediccionChart'), {
                type: 'line',
                data: {
                    labels: getD('d-pred-l'),
                    datasets: [{ label: 'IA Predicción', data: pV, borderColor: '#00ccff', borderDash: [5,5], pointBackgroundColor: '#00ccff', tension: 0.3 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
        } else { document.getElementById('prediccionChart').parentElement.innerHTML = "<div style='height:100%;display:flex;align-items:center;justify-content:center;color:#666'><i class='fas fa-info-circle'></i>&nbsp;Faltan datos para IA</div>"; }

        // 3. PREDICCIÓN CLIENTES (IA)
        const cV = getD('d-cli-v');
        if(cV.length > 0) {
            new Chart(document.getElementById('clientesChart'), {
                type: 'line',
                data: {
                    labels: getD('d-cli-l'),
                    datasets: [{ 
                        label: 'Clientes Proyectados', 
                        data: cV, 
                        borderColor: '#a855f7', 
                        backgroundColor: 'rgba(168, 85, 247, 0.1)',
                        fill: true, borderWidth: 2, tension: 0.4, pointRadius: 4
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
        } else { document.getElementById('clientesChart').parentElement.innerHTML = "<div style='height:100%;display:flex;align-items:center;justify-content:center;color:#666'><i class='fas fa-user-slash'></i>&nbsp;Faltan datos de clientes</div>"; }

        // 4. EMBUDO
        new Chart(document.getElementById('embudoChart'), {
            type: 'doughnut',
            data: {
                labels: getD('d-embudo-l'),
                datasets: [{ data: getD('d-embudo-v'), backgroundColor: ['#00ff88', '#00ccff', '#ff4757', '#ffa500'], borderColor: '#111' }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: '#ccc', usePointStyle: true } } } }
        });

        // 5. PRODUCTOS
        new Chart(document.getElementById('productosChart'), {
            type: 'bar',
            data: {
                labels: getD('d-prod-l'),
                datasets: [{ label: 'Solicitudes', data: getD('d-prod-v'), backgroundColor: 'rgba(0,255,136,0.6)', borderColor: '#00ff88', borderWidth: 1, borderRadius: 4 }]
            },
            options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });
    });
</script>
</body>
</html>
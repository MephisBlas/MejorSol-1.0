
{% load static %}

{% block content %}
 <link rel="stylesheet" href="{% static 'css/admin_productos.css' %}">
<div class="admin-content">
    <div class="content-header">
        <div class="header-left">
            <h1>Gestión de Productos</h1>
            <p>Administra el inventario de productos</p>
        </div>
        <div class="header-right">
            <a href="{% url 'producto_create' %}" class="btn btn-primary">
                <i class="fas fa-plus"></i>
                Nuevo Producto
            </a>
        </div>
    </div>

    <!-- Filtros -->
    <div class="filters-card">
        <h3>Filtros</h3>
        <form method="get" class="filter-form">
            <div class="filter-row">
                <div class="filter-group">
                    <label>Categoría:</label>
                    <select name="categoria" class="form-control">
                        <option value="">Todas las categorías</option>
                        {% for cat in categorias %}
                            <option value="{{ cat }}" {% if filtro_categoria == cat %}selected{% endif %}>
                                {{ cat }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="filter-group">
                    <label>Estado:</label>
                    <select name="estado" class="form-control">
                        <option value="">Todos los estados</option>
                        <option value="activo" {% if filtro_estado == 'activo' %}selected{% endif %}>Activo</option>
                        <option value="inactivo" {% if filtro_estado == 'inactivo' %}selected{% endif %}>Inactivo</option>
                    </select>
                </div>
                <div class="filter-group">
                    <button type="submit" class="btn btn-outline">
                        <i class="fas fa-filter"></i>
                        Filtrar
                    </button>
                    <a href="{% url 'productos_list' %}" class="btn btn-outline">
                        <i class="fas fa-refresh"></i>
                        Limpiar
                    </a>
                </div>
            </div>
        </form>
    </div>

    <!-- Mensajes -->
    {% if messages %}
    <div class="messages-container">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">
            <i class="fas fa-{% if message.tags == 'success' %}check-circle{% else %}exclamation-triangle{% endif %}"></i>
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Tabla de Productos -->
    <div class="table-card">
        <div class="table-responsive">
            <table class="products-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nombre</th>
                        <th>Categoría</th>
                        <th>Precio</th>
                        <th>Stock</th>
                        <th>Stock Mínimo</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for producto in productos %}
                    <tr class="product-row" data-product-id="{{ producto.id }}">
                        <td>
                            <strong>#{{ producto.id }}</strong>
                        </td>
                        <td>
                            <div class="product-info">
                                <strong>{{ producto.nombre }}</strong>
                                {% if producto.descripcion %}
                                <small>{{ producto.descripcion|truncatewords:5 }}</small>
                                {% endif %}
                            </div>
                        </td>
                        <td>{{ producto.categoria }}</td>
                        <td>$ {{ producto.precio }}</td>
                        <td>
                            <span class="stock-badge {% if producto.stock <= producto.stock_minimo %}stock-low{% elif producto.stock == 0 %}stock-out{% else %}stock-normal{% endif %}">
                                {{ producto.stock }}
                                {% if producto.stock <= producto.stock_minimo and producto.stock > 0 %}
                                <i class="fas fa-exclamation-triangle" title="Stock bajo"></i>
                                {% elif producto.stock == 0 %}
                                <i class="fas fa-times-circle" title="Stock agotado"></i>
                                {% endif %}
                            </span>
                        </td>
                        <td>{{ producto.stock_minimo }}</td>
                        <td>
                            <span class="status-badge {% if producto.activo %}status-active{% else %}status-inactive{% endif %}">
                                {% if producto.activo %}Activo{% else %}Inactivo{% endif %}
                            </span>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-icon btn-view" title="Ver detalles" onclick="openModal('{{ producto.id }}')">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <a href="{% url 'producto_edit' producto.id %}" class="btn-icon btn-edit" title="Editar">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <form method="post" action="{% url 'producto_delete' producto.id %}" class="d-inline delete-form">
                                    {% csrf_token %}
                                    <button type="submit" class="btn-icon btn-delete" title="Eliminar" onclick="return confirm('¿Estás seguro de eliminar {{ producto.nombre }}?')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" class="text-center">
                            <div class="empty-state">
                                <i class="fas fa-box-open"></i>
                                <h3>No hay productos</h3>
                                <p>Comienza agregando tu primer producto al inventario.</p>
                                <a href="{% url 'producto_create' %}" class="btn btn-primary">
                                    <i class="fas fa-plus"></i>
                                    Crear Producto
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Paginación -->
    {% if productos.has_other_pages %}
    <div class="pagination-container">
        <div class="pagination">
            {% if productos.has_previous %}
                <a href="?page=1{% if filtro_categoria %}&categoria={{ filtro_categoria }}{% endif %}{% if filtro_estado %}&estado={{ filtro_estado }}{% endif %}" class="page-link">&laquo; Primera</a>
                <a href="?page={{ productos.previous_page_number }}{% if filtro_categoria %}&categoria={{ filtro_categoria }}{% endif %}{% if filtro_estado %}&estado={{ filtro_estado }}{% endif %}" class="page-link">Anterior</a>
            {% endif %}

            <span class="current-page">
                Página {{ productos.number }} de {{ productos.paginator.num_pages }}
            </span>

            {% if productos.has_next %}
                <a href="?page={{ productos.next_page_number }}{% if filtro_categoria %}&categoria={{ filtro_categoria }}{% endif %}{% if filtro_estado %}&estado={{ filtro_estado }}{% endif %}" class="page-link">Siguiente</a>
                <a href="?page={{ productos.paginator.num_pages }}{% if filtro_categoria %}&categoria={{ filtro_categoria }}{% endif %}{% if filtro_estado %}&estado={{ filtro_estado }}{% endif %}" class="page-link">Última &raquo;</a>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>

<!-- Modal para detalles -->
<div id="productModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Detalles del Producto</h3>
            <span class="close" onclick="closeModal()">&times;</span>
        </div>
        <div class="modal-body" id="modalBody">
            <!-- Contenido cargado via AJAX -->
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function openModal(productId) {
    // Cargar detalles del producto via AJAX
    fetch(`/admin/productos/detalle/${productId}/`)
        .then(response => response.text())
        .then(html => {
            document.getElementById('modalBody').innerHTML = html;
            document.getElementById('productModal').style.display = 'block';
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('modalBody').innerHTML = '<p>Error al cargar los detalles del producto.</p>';
            document.getElementById('productModal').style.display = 'block';
        });
}

function closeModal() {
    document.getElementById('productModal').style.display = 'none';
}

// Cerrar modal al hacer click fuera
window.onclick = function(event) {
    const modal = document.getElementById('productModal');
    if (event.target == modal) {
        closeModal();
    }
}
</script>
{% endblock %}
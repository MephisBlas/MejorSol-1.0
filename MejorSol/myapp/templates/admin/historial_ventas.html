{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Historial de Ventas - SIEER Chile</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="{% static 'css/base.css' %}">
  <link rel="stylesheet" href="{% static 'css/admin_panel.css' %}">
  <style>
    .filters{display:grid;grid-template-columns:1fr 1fr 1fr 1fr auto;gap:.75rem;margin-bottom:1rem}
    .filters input,.filters select{background:#14161a;color:#e7f5ef;border:1px solid #2a2f36;border-radius:.6rem;padding:.55rem .7rem}
    .filters .btn{height:42px}
    .table{width:100%;border-collapse:collapse;background:#121417;border-radius:.8rem;overflow:hidden}
    .table th,.table td{padding:.75rem 1rem;border-bottom:1px solid #222831}
    .table th{background:#0f1115;color:#8ef3c5;text-align:left;font-weight:600}
    .table tr:hover{background:#151821}
    .badge{padding:.2rem .5rem;border-radius:.5rem;font-size:.82rem}
    .badge.ok{background:#103b2b;color:#7dffb8}
    .badge.warn{background:#3a2f10;color:#ffd66b}
    .badge.err{background:#3b1010;color:#ffa1a1}
    .pagination{display:flex;gap:.5rem;justify-content:flex-end;margin-top:1rem}
    .pagination a,.pagination span{padding:.4rem .7rem;border:1px solid #2a2f36;border-radius:.5rem;text-decoration:none;color:#e7f5ef}
    .pagination .active{background:#0acf83;border-color:#0acf83;color:#0a0e12}
  </style>
</head>

<body>
<div class="admin-container">

  <!-- Sidebar -->
  <aside class="admin-sidebar">
    <div class="sidebar-header">
      <div class="admin-logo">
        <img src="{% static 'img/logo.png' %}" alt="SIEER Chile Logo">
        <div class="logo-text"><h2>SIEER Chile</h2><span>Panel Administrativo</span></div>
      </div>
    </div>

    <nav class="sidebar-nav">
      <div class="nav-section">
        <h3>Facturación</h3>
        <ul>
          <li class="nav-item"><a href="{% url 'admin_panel' %}"><i class="fas fa-file-invoice"></i><span>Boleta y Factura Electrónica</span></a></li>
          <li class="nav-item"><a href="{% url 'calculos_estadisticas' %}"><i class="fas fa-calculator"></i><span>Cálculos y Estadísticas</span></a></li>
          <li class="nav-item"><a href="{% url 'cotizaciones' %}"><i class="fas fa-file-alt"></i><span>Cotizaciones</span></a></li>
          <li class="nav-item"><a href="{% url 'control_inventario' %}"><i class="fas fa-boxes"></i><span>Control de Inventario</span></a></li>
        </ul>
      </div>

      <div class="nav-section">
        <h3>Reportes</h3>
        <ul>
          <li class="nav-item"><a href="{% url 'reportes_graficos' %}"><i class="fas fa-chart-bar"></i><span>Reportes Gráficos</span></a></li>
          <li class="nav-item active"><a href="{% url 'historial_ventas' %}"><i class="fas fa-history"></i><span>Historia de Ventas</span></a></li>
          <li class="nav-item"><a href="#"><i class="fas fa-user-cog"></i><span>Cuenta</span></a></li>
          <li class="nav-item"><a href="{% url 'admin_panel' %}"><i class="fas fa-cogs"></i><span>Configuración</span></a></li>
        </ul>
      </div>
    </nav>

    <div class="sidebar-footer">
      <div class="user-info">
        <div class="user-avatar"><i class="fas fa-user-shield"></i></div>
        <div class="user-details"><strong>Administrador</strong><span>{{ user.username }}</span></div>
      </div>
      <form method="post" action="{% url 'logout' %}" class="logout-form">
        {% csrf_token %}
        <button type="submit" class="logout-btn"><i class="fas fa-sign-out-alt"></i> Cerrar Sesión</button>
      </form>
    </div>
  </aside>

  <!-- Main -->
  <main class="admin-main">
    <header class="admin-header">
      <div class="header-left">
        <button class="menu-toggle" id="menuToggle"><i class="fas fa-bars"></i></button>
        <h1>Historial de Ventas</h1>
      </div>
      <div class="header-right">
        <a class="btn btn-primary" href="{% url 'admin_panel' %}"><i class="fas fa-arrow-left"></i> Volver al Panel</a>
      </div>
    </header>

    <div class="admin-content">
      <!-- Filtros -->
      <form class="filters" method="get">
        <input type="text" name="q" placeholder="Buscar número o cliente…" value="{{ q }}">
        <select name="estado">
          <option value="">Estado (todos)</option>
          <option value="Pagada"    {% if estado == 'Pagada' %}selected{% endif %}>Pagada</option>
          <option value="Pendiente" {% if estado == 'Pendiente' %}selected{% endif %}>Pendiente</option>
          <option value="Anulada"   {% if estado == 'Anulada' %}selected{% endif %}>Anulada</option>
        </select>
        <input type="date" name="desde" value="{{ desde }}">
        <input type="date" name="hasta" value="{{ hasta }}">
        <button class="btn btn-primary" type="submit"><i class="fas fa-filter"></i> Filtrar</button>
        <a class="btn btn-outline" href="{% url 'historial_ventas' %}"><i class="fas fa-rotate"></i> Limpiar</a>
        <a class="btn btn-outline" href="?q={{ q }}&estado={{ estado }}&desde={{ desde }}&hasta={{ hasta }}&export=csv">
          <i class="fas fa-file-csv"></i> Exportar CSV
        </a>
      </form>

      <!-- Tabla -->
      <table class="table">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>N° Documento</th>
            <th>Cliente</th>
            <th>Total</th>
            <th>Estado</th>
            <th>Método de Pago</th>
          </tr>
        </thead>
        <tbody>
          {% if ventas %}
            {% for v in ventas %}
              <tr>
                <td>
                  {% if v.fecha %}{{ v.fecha|date:"Y-m-d" }}{% else %}—{% endif %}
                </td>
                <td>{{ v.numero }}</td>
                <td>{{ v.cliente }}</td>
                <td>${{ v.total }}</td>
                <td>
                  {% with st=v.estado|default_if_none:"" %}
                    {% if st|lower == "pagada" %}<span class="badge ok">Pagada</span>
                    {% elif st|lower == "pendiente" %}<span class="badge warn">Pendiente</span>
                    {% elif st|lower == "anulada" %}<span class="badge err">Anulada</span>
                    {% else %}<span class="badge">{{ v.estado }}</span>
                    {% endif %}
                  {% endwith %}
                </td>
                <td>{{ v.metodo_pago|default:"" }}</td>
              </tr>
            {% endfor %}
          {% else %}
            <tr><td colspan="6">No se encontraron ventas con esos filtros.</td></tr>
          {% endif %}
        </tbody>
      </table>

      <!-- Paginación (si hay queryset real) -->
      {% if page_obj %}
        <div class="pagination">
          {% if page_obj.has_previous %}
            <a href="?page=1&q={{ q }}&estado={{ estado }}&desde={{ desde }}&hasta={{ hasta }}">« Primero</a>
            <a href="?page={{ page_obj.previous_page_number }}&q={{ q }}&estado={{ estado }}&desde={{ desde }}&hasta={{ hasta }}">‹ Anterior</a>
          {% endif %}
          <span class="active">Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span>
          {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}&q={{ q }}&estado={{ estado }}&desde={{ desde }}&hasta={{ hasta }}">Siguiente ›</a>
            <a href="?page={{ page_obj.paginator.num_pages }}&q={{ q }}&estado={{ estado }}&desde={{ desde }}&hasta={{ hasta }}">Última »</a>
          {% endif %}
        </div>
      {% endif %}
    </div>
  </main>
</div>

<script src="{% static 'js/admin_panel.js' %}"></script>
</body>
</html>

{% load static %}
{% load humanize %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cotizaciones - SIEER Chile</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    /* ======================================= */
    /* 1. VARIABLES Y RESET (NEÓN OSCURO)
    /* ======================================= */
    :root {
        --neon-green: #00ff88;
        --neon-hover: #00cc6a;
        --bg-dark: #050505;
        --bg-panel: #0f0f0f;
        --border-neon: 1px solid rgba(0, 255, 136, 0.2);
        --text-white: #ffffff;
        
        /* Colores de Estado para el Switch */
        --st-pendiente: #ffa502;
        --st-proceso: #1e90ff;
        --st-aprobada: #00ff88;
        --st-rechazada: #ff4757;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    html, body {
        margin: 0; padding: 0; width: 100%; height: 100%;
        background-color: var(--bg-dark);
        font-family: 'Roboto', sans-serif;
        color: var(--text-white);
        overflow: hidden; 
    }

    .admin-container { display: flex; width: 100vw; height: 100vh; }

    /* SIDEBAR (Estilos originales resumidos) */
    .admin-sidebar { width: 280px; height: 100%; background: var(--bg-panel); border-right: var(--border-neon); display: flex; flex-direction: column; flex-shrink: 0; z-index: 1000; transition: transform 0.3s ease; }
    .sidebar-header { padding: 1.5rem; border-bottom: 1px solid rgba(255,255,255,0.05); }
    .admin-logo { display: flex; align-items: center; gap: 1rem; }
    .admin-logo img { height: 45px; filter: drop-shadow(0 0 5px rgba(0,255,136,0.4)); }
    .logo-text h2 { margin: 0; color: #fff; font-size: 1.3rem; font-family: 'Montserrat', sans-serif; text-transform: uppercase; }
    .logo-text span { color: var(--neon-green); font-size: 0.75rem; letter-spacing: 1px; }
    .sidebar-nav { flex: 1; overflow-y: auto; padding: 1rem; }
    .nav-section h3 { color: #666; font-size: 0.8rem; text-transform: uppercase; margin: 1.5rem 0 0.5rem 0.5rem; }
    .nav-item { list-style: none; margin-bottom: 0.5rem; }
    .nav-item a { display: flex; align-items: center; gap: 12px; padding: 12px 15px; color: #b0b0b0; text-decoration: none; border-radius: 8px; transition: 0.3s; font-size: 0.95rem; font-weight: 500; }
    .nav-item a:hover, .nav-item.active a { background: rgba(0, 255, 136, 0.08); color: var(--neon-green); }
    .nav-item.active a { border-left: 3px solid var(--neon-green); }
    .sidebar-footer { padding: 1.5rem; border-top: 1px solid rgba(255,255,255,0.05); }
    .logout-btn { width: 100%; padding: 12px; background: rgba(255, 71, 87, 0.1); color: #ff4757; border: 1px solid rgba(255, 71, 87, 0.3); border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; justify-content: center; gap: 8px; }

    /* MAIN */
    .admin-main { flex-grow: 1; height: 100%; background: var(--bg-dark); display: flex; flex-direction: column; overflow-y: auto; position: relative; }
    .admin-header { padding: 1rem 2rem; background: var(--bg-panel); border-bottom: var(--border-neon); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 500; }
    .header-left h1 { margin: 0; color: #fff; font-family: 'Montserrat', sans-serif; font-size: 1.5rem; }
    .menu-toggle { display: none; color: var(--neon-green); background: none; border: 1px solid #333; padding: 8px; border-radius: 8px; font-size: 1.2rem; cursor: pointer; }
    .btn-back { background: var(--neon-green); color: #000; padding: 10px 25px; border-radius: 50px; text-decoration: none; font-weight: 700; display: flex; align-items: center; gap: 8px; }

    /* CONTENT */
    .admin-content { padding: 2rem; }
    .content-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem; }
    .content-header h2 { color: var(--neon-green); font-family: 'Montserrat', sans-serif; font-size: 1.5rem; }
    .toolbar { display: flex; gap: 1rem; flex-wrap: wrap; }
    .search { display: flex; align-items: center; gap: 10px; background: #0f0f0f; border: 1px solid #333; padding: 10px 15px; border-radius: 10px; }
    .search input { background: transparent; border: none; color: #fff; outline: none; width: 200px; }
    .filter-select { background: #0f0f0f; color: #fff; border: 1px solid #333; padding: 10px 15px; border-radius: 10px; cursor: pointer; }

    /* TABLE CARD */
    .table-card { background: var(--bg-panel); border: var(--border-neon); border-radius: 16px; overflow: hidden; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
    .card-head { padding: 1rem 1.5rem; background: rgba(255,255,255,0.02); border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; justify-content: space-between; color: #888; }
    .table-responsive { overflow-x: auto; min-height: 400px; } /* Altura mínima para desplegables */
    
    .styled-table { width: 100%; border-collapse: collapse; }
    .styled-table th { text-align: left; padding: 1rem 1.5rem; background: rgba(0, 255, 136, 0.05); color: var(--neon-green); font-weight: 600; text-transform: uppercase; white-space: nowrap; }
    .styled-table td { padding: 1rem 1.5rem; color: #e0e0e0; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 0.95rem; vertical-align: middle; }
    .styled-table tr:hover { background: rgba(255,255,255,0.02); }

    /* ======================================= */
    /* NUEVO ESTILO: SELECTOR DE ESTADO
    /* ======================================= */
    .status-selector {
        appearance: none;
        -webkit-appearance: none;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        cursor: pointer;
        border: 1px solid transparent;
        outline: none;
        text-align: center;
        width: 120px;
        transition: all 0.3s ease;
        color: #000; /* Texto negro para contraste */
    }

    /* Colores dinámicos del select */
    .status-selector[data-val="pendiente"] { background: var(--st-pendiente); box-shadow: 0 0 10px rgba(255, 165, 2, 0.3); }
    .status-selector[data-val="en_proceso"] { background: var(--st-proceso); box-shadow: 0 0 10px rgba(30, 144, 255, 0.3); }
    .status-selector[data-val="aprobada"] { background: var(--st-aprobada); box-shadow: 0 0 10px rgba(0, 255, 136, 0.3); }
    .status-selector[data-val="rechazada"] { background: var(--st-rechazada); color: #fff; box-shadow: 0 0 10px rgba(255, 71, 87, 0.3); }

    .status-selector:hover { transform: scale(1.05); filter: brightness(1.1); }
    .status-selector option { background-color: #121212; color: #fff; } /* Opciones oscuras */

    /* ACCIONES */
    .table-actions { display: flex; gap: 8px; }
    .btn-sm { padding: 6px 12px; border-radius: 6px; font-size: 0.85rem; font-weight: 600; text-decoration: none; display: inline-flex; align-items: center; gap: 5px; transition: 0.3s; }
    .btn-chat { background: transparent; color: var(--neon-green); border: 1px solid var(--neon-green); }
    .btn-chat:hover { background: var(--neon-green); color: #000; }
    .btn-danger { background: transparent; color: #ff4757; border: 1px solid #ff4757; }
    .btn-danger:hover { background: #ff4757; color: #fff; }

    .chat-modal-container { position: fixed; bottom: 80px; right: 20px; width: 400px; height: 600px; background: var(--bg-panel); border: 1px solid var(--neon-green); border-radius: 16px; box-shadow: 0 10px 50px rgba(0,0,0,0.8); z-index: 2000; display: none; flex-direction: column; }
    .chat-modal-header { display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: #000; border-bottom: 1px solid #333; border-radius: 16px 16px 0 0; }
    .chat-modal-body { flex: 1; overflow: hidden; background: #121212; }
    .chat-modal-body iframe { width: 100%; height: 100%; border: none; }
    .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 999; }

    @media (max-width: 992px) {
        .admin-sidebar { position: fixed; left: -280px; } .admin-sidebar.active { left: 0; } .sidebar-overlay.active { display: block; } .menu-toggle { display: block; }
        .admin-content { padding: 1rem; }
        .chat-modal-container { width: 100%; height: 100%; bottom: 0; right: 0; border-radius: 0; }
        .styled-table th:nth-child(1), .styled-table td:nth-child(1), .styled-table th:nth-child(3), .styled-table td:nth-child(3) { display: none; }
    }
  </style>
</head>

<body>
<div class="admin-container">

  <aside class="admin-sidebar" id="adminSidebar">
    <div class="sidebar-header">
        <div class="admin-logo">
            <img src="{% static 'img/logo.png' %}" alt="SIEER">
            <div class="logo-text"><h2>SIEER Chile</h2><span>Panel Admin</span></div>
        </div>
    </div>
    <nav class="sidebar-nav">
        <div class="nav-section">
            <h3>Facturación</h3>
            <ul>
                <li class="nav-item {% if request.resolver_match.url_name == 'admin_panel' %}active{% endif %}"><a href="{% url 'admin_panel' %}"><i class="fas fa-tachometer-alt"></i><span>Dashboard</span></a></li>
                <li class="nav-item {% if request.resolver_match.url_name == 'calculos_estadisticas' %}active{% endif %}"><a href="{% url 'calculos_estadisticas' %}"><i class="fas fa-calculator"></i><span>Cálculos</span></a></li>
                <li class="nav-item {% if request.resolver_match.url_name == 'cotizaciones' %}active{% endif %}"><a href="{% url 'cotizaciones' %}"><i class="fas fa-file-invoice-dollar"></i><span>Cotizaciones</span></a></li>
                <li class="nav-item {% if request.resolver_match.url_name == 'control_inventario' %}active{% endif %}"><a href="{% url 'control_inventario' %}"><i class="fas fa-boxes"></i><span>Inventario</span></a></li>
            </ul>
        </div>
        <div class="nav-section">
            <h3>Reportes</h3>
            <ul>
                <li class="nav-item {% if request.resolver_match.url_name == 'reportes_graficos' %}active{% endif %}"><a href="{% url 'reportes_graficos' %}"><i class="fas fa-chart-bar"></i><span>Gráficos</span></a></li>
                <li class="nav-item {% if request.resolver_match.url_name == 'historial_cotizaciones' %}active{% endif %}"><a href="{% url 'historial_cotizaciones' %}"><i class="fas fa-history"></i><span>Historial</span></a></li>
                <li class="nav-item {% if request.resolver_match.url_name == 'cuenta' %}active{% endif %}"><a href="{% url 'cuenta' %}"><i class="fas fa-user-cog"></i><span>Cuenta</span></a></li>
                <li class="nav-item {% if request.resolver_match.url_name == 'configuracion' %}active{% endif %}"><a href="{% url 'configuracion' %}"><i class="fas fa-cogs"></i><span>Configuración</span></a></li>
            </ul>
        </div>
    </nav>
    <div class="sidebar-footer">
        <div class="user-info">
            <div class="user-avatar"><i class="fas fa-user-shield"></i></div>
            <div class="user-details"><strong>{{ user.username }}</strong><span>Administrador</span></div>
        </div>
        <form method="post" action="{% url 'logout' %}" class="logout-form">
            {% csrf_token %}
            <button type="submit" class="logout-btn"><i class="fas fa-sign-out-alt"></i> Cerrar Sesión</button>
        </form>
    </div>
  </aside>

  <div class="sidebar-overlay" id="sidebarOverlay"></div>

  <main class="admin-main">
    <header class="admin-header">
      <div class="header-left">
        <button class="menu-toggle" id="menuToggle"><i class="fas fa-bars"></i></button>
        <h1>Cotizaciones</h1>
      </div>
      <div class="header-right">
        <a class="btn-back" href="{% url 'admin_panel' %}"><i class="fas fa-arrow-left"></i> <span>Volver</span></a>
      </div>
    </header>

    <div class="admin-content">
      <div class="content-header">
        <h2>Gestión de Solicitudes</h2>
        <div class="toolbar">
          <form method="get" action="{% url 'cotizaciones' %}" class="search">
            <i class="fas fa-search"></i>
            <input type="text" name="q" placeholder="Buscar cliente..." value="{{ request.GET.q }}">
          </form>
          <form method="get" action="{% url 'cotizaciones' %}">
            <select name="estado" class="filter-select" onchange="this.form.submit()">
              <option value="">Todos los estados</option>
              <option value="pendiente" {% if request.GET.estado == 'pendiente' %}selected{% endif %}>Pendientes</option>
              <option value="en_proceso" {% if request.GET.estado == 'en_proceso' %}selected{% endif %}>En Proceso</option>
              <option value="aprobada" {% if request.GET.estado == 'aprobada' %}selected{% endif %}>Aprobadas</option>
              <option value="rechazada" {% if request.GET.estado == 'rechazada' %}selected{% endif %}>Rechazadas</option>
            </select>
          </form>
        </div>
      </div>

      <div class="table-card">
        <div class="card-head">
          <span><i class="fas fa-list"></i> Listado Reciente</span>
          <span>Total: {{ chats_cotizacion|length }}</span> 
        </div>

        {% if chats_cotizacion %}
        <div class="table-responsive">
          <table class="styled-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Cliente</th>
                <th>Fecha</th>
                <th>Producto</th>
                <th>Estado</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              {% for cot in chats_cotizacion %}
              <tr>
                <td>#{{ cot.id }}</td>
                <td>{{ cot.cliente.get_full_name|default:cot.cliente.username }}</td>
                <td>{{ cot.fecha_actualizacion|date:"d/m/Y" }}</td>
                <td>{{ cot.producto.nombre }}</td>
                <td>
                  <select 
                    onchange="actualizarEstado('{{ cot.id }}', this)" 
                    class="status-selector" 
                    data-val="{{ cot.estado }}">
                    
                    <option value="pendiente" {% if cot.estado == 'pendiente' %}selected{% endif %}>Pendiente</option>
                    <option value="en_proceso" {% if cot.estado == 'en_proceso' %}selected{% endif %}>En Proceso</option>
                    <option value="aprobada" {% if cot.estado == 'aprobada' %}selected{% endif %}>Aprobada</option>
                    <option value="rechazada" {% if cot.estado == 'rechazada' %}selected{% endif %}>Rechazada</option>
                  </select>
                </td>
                <td>
                  <div class="table-actions">
                    <button onclick="openChatModal('{{ cot.id }}')" class="btn-sm btn-chat" title="Chat">
                        <i class="fas fa-comments"></i> Chat
                    </button>
                    <a href="{% url 'eliminar_cotizacion' cot.id %}" class="btn-sm btn-danger" title="Eliminar" onclick="return confirm('¿Seguro que deseas eliminar esta cotización?');">
                        <i class="fas fa-trash"></i>
                    </a>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <div class="empty-state">
          <i class="fas fa-folder-open"></i>
          <h3>No hay cotizaciones</h3>
          <p>Las nuevas solicitudes aparecerán aquí.</p>
        </div>
        {% endif %}
      </div>
    </div>
  </main>
</div>

<div class="chat-modal-container" id="adminChatModalContainer">
    <div class="chat-modal-header">
        <h3 id="adminChatModalTitle">Chat</h3>
        <button id="adminChatModalCloseBtn">&times;</button>
    </div>
    <div class="chat-modal-body">
        <iframe id="admin-chat-iframe" src="about:blank" frameborder="0"></iframe>
    </div>
</div>

<script>
    // --- TOKEN CSRF ---
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    // --- LÓGICA PARA ACTUALIZAR ESTADO (AJAX) ---
    async function actualizarEstado(chatId, selectElement) {
        const nuevoEstado = selectElement.value;
        
        // Efecto visual inmediato (cambio de color)
        selectElement.setAttribute('data-val', nuevoEstado);
        
        try {
            // Asegúrate de que esta URL coincida con la que pongas en urls.py
            const url = `/api/cotizacion/${chatId}/estado/`;
            
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify({ 'nuevo_estado': nuevoEstado })
            });

            const data = await response.json();
            
            if (data.status === 'ok') {
                // Opcional: Mostrar notificación pequeña de éxito
                console.log('Estado actualizado:', data.mensaje);
            } else {
                alert('Error al actualizar: ' + data.mensaje);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error de conexión al actualizar el estado.');
        }
    }

    // --- Lógica Menú Móvil ---
    document.addEventListener('DOMContentLoaded', () => {
        const menuToggle = document.getElementById('menuToggle');
        const sidebar = document.getElementById('adminSidebar');
        const overlay = document.getElementById('sidebarOverlay');

        if (menuToggle) {
            menuToggle.addEventListener('click', () => {
                sidebar.classList.toggle('active');
                overlay.classList.toggle('active');
            });
            overlay.addEventListener('click', () => {
                sidebar.classList.remove('active');
                overlay.classList.remove('active');
            });
        }
    });

    // --- Lógica Chat Modal ---
    const chatModalContainer = document.getElementById('adminChatModalContainer');
    const chatIframe = document.getElementById('admin-chat-iframe');
    const chatModalCloseBtn = document.getElementById('adminChatModalCloseBtn');
    const chatModalTitle = document.getElementById('adminChatModalTitle');

    const chatBaseUrl = "{% url 'admin_chat_cotizacion' chat_id=0 %}".slice(0, -2); 

    function openChatModal(chatId) {
        chatIframe.src = chatBaseUrl + chatId + '/';
        chatModalTitle.textContent = `Cotización #${chatId}`;
        chatModalContainer.style.display = 'flex';
    }

    function closeChatModal() {
        chatIframe.src = 'about:blank';
        chatModalContainer.style.display = 'none';
    }

    if(chatModalCloseBtn) chatModalCloseBtn.addEventListener('click', closeChatModal);
</script>

</body>
</html>
{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Control de Inventario - SIEER Chile</title>

  <!-- mismas dependencias del panel -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <link rel="stylesheet" href="{% static 'css/base.css' %}">
  <link rel="stylesheet" href="{% static 'css/admin_panel.css' %}">
  <link rel="stylesheet" href="{% static 'css/inventario.css' %}">
</head>
<body>
<div class="admin-container">
  <!-- Sidebar -->
  <aside class="admin-sidebar">
    <div class="sidebar-header">
      <div class="admin-logo">
        <img src="{% static 'img/logo.png' %}" alt="SIEER Chile Logo">
        <div class="logo-text">
          <h2>SIEER Chile</h2>
          <span>Panel Administrativo</span>
        </div>
      </div>
    </div>

    <nav class="sidebar-nav">
      <div class="nav-section">
        <h3>Facturación</h3>
        <ul>
          <li class="nav-item {% if request.resolver_match.url_name == 'admin_panel' %}active{% endif %}">
            <a href="{% url 'admin_panel' %}">
              <i class="fas fa-file-invoice"></i><span>Boleta y Factura Electrónica</span>
            </a>
          </li>
          <li class="nav-item {% if request.resolver_match.url_name == 'calculos_estadisticas' %}active{% endif %}">
            <a href="{% url 'calculos_estadisticas' %}">
              <i class="fas fa-calculator"></i><span>Cálculos y Estadísticas</span>
            </a>
          </li>
          <li class="nav-item {% if request.resolver_match.url_name == 'cotizaciones' %}active{% endif %}">
            <a href="{% url 'cotizaciones' %}">
              <i class="fas fa-file-alt"></i><span>Cotizaciones</span>
            </a>
          </li>
          <li class="nav-item {% if request.resolver_match.url_name == 'control_inventario' %}active{% endif %}">
            <a href="{% url 'control_inventario' %}">
              <i class="fas fa-boxes"></i><span>Control de Inventario</span>
            </a>
          </li>
        </ul>
      </div>
      <div class="nav-section">
        <h3>Reportes</h3>
        <ul>
          <li class="nav-item {% if request.resolver_match.url_name == 'reportes_graficos' %}active{% endif %}">
            <a href="{% url 'reportes_graficos' %}">
              <i class="fas fa-chart-bar"></i><span>Reportes Gráficos</span>
            </a>
          </li>
          <li class="nav-item {% if request.resolver_match.url_name == 'historial_ventas' %}active{% endif %}">
            <a href="{% url 'historial_ventas' %}">
              <i class="fas fa-history"></i><span>Historial de Ventas</span>
            </a>
          </li>
          <li class="nav-item {% if request.resolver_match.url_name == 'cuenta' %}active{% endif %}">
            <a href="{% url 'cuenta' %}">
              <i class="fas fa-user-cog"></i><span>Cuenta</span>
            </a>
          </li>
          <li class="nav-item {% if request.resolver_match.url_name == 'configuracion' %}active{% endif %}">
            <a href="{% url 'configuracion' %}">
              <i class="fas fa-cogs"></i><span>Configuración</span>
            </a>
          </li>
        </ul>
      </div>
    </nav>

    <div class="sidebar-footer">
      <div class="user-info">
        <div class="user-avatar"><i class="fas fa-user-shield"></i></div>
        <div class="user-details"><strong>Administrador</strong><span>{{ user.username }}</span></div>
      </div>
      <form method="post" action="{% url 'logout' %}" class="logout-form">
        {% csrf_token %}
        <button type="submit" class="logout-btn"><i class="fas fa-sign-out-alt"></i>Cerrar Sesión</button>
      </form>
    </div>
  </aside>

  <!-- Main -->
  <main class="admin-main inv-page">
    <header class="admin-header">
      <div class="header-left">
        <button class="menu-toggle" id="menuToggle"><i class="fas fa-bars"></i></button>
        <h1>Control de <span class="accent">Inventario</span></h1>
      </div>
      <div class="header-right">
        <button class="btn btn-primary" onclick="window.location.href='/'">
          <i class="fas fa-eye"></i> VER SITIO WEB
        </button>
        <div class="notification-bell"><i class="fas fa-bell"></i><span class="notification-count">3</span></div>
      </div>
    </header>

    <div class="admin-content inv-container">
      <!-- Mensajes de Django -->
      {% if messages %}
      <div class="messages-container">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">
          {{ message }}
        </div>
        {% endfor %}
      </div>
      {% endif %}

      <!-- Filtros y acciones -->
      <section class="inv-toolbar card">
        <form method="GET" class="filter-form">
          <input type="text" name="q" value="{{ request.GET.q }}" class="input search" placeholder="Buscar por SKU o nombre…">
          <select name="categoria" class="input">
            <option value="">Todas las categorías</option>
            {% for categoria in categorias %}
            <option value="{{ categoria.id }}" {% if request.GET.categoria == categoria.id|stringformat:"i" %}selected{% endif %}>
              {{ categoria.nombre }}
            </option>
            {% endfor %}
          </select>
          <select name="estado" class="input">
            <option value="">Todos los estados</option>
            <option value="activo" {% if request.GET.estado == 'activo' %}selected{% endif %}>Activos</option>
            <option value="inactivo" {% if request.GET.estado == 'inactivo' %}selected{% endif %}>Inactivos</option>
            <option value="bajo" {% if request.GET.estado == 'bajo' %}selected{% endif %}>Stock Bajo</option>
          </select>

          <div class="toolbar-actions">
            <button type="submit" class="btn btn-outline">
              <i class="fas fa-search"></i> Buscar
            </button>
            <a href="{% url 'producto_create' %}" class="btn btn-solid">
              <i class="fas fa-plus"></i> Nuevo producto
            </a>
            <a href="{% url 'control_inventario' %}?export=csv" class="btn btn-outline">
              <i class="fas fa-download"></i> Exportar CSV
            </a>
          </div>
        </form>
      </section>

      <!-- Tabla -->
      <section class="card inv-table-wrap">
        <table class="inv-table" id="tablaInventario">
          <thead>
            <tr>
              <th>SKU</th>
              <th>Producto</th>
              <th>Categoría</th>
              <th class="num">Stock</th>
              <th class="num">Mínimo</th>
              <th>Estado</th>
              <th class="num">Precio ($)</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="tbodyInventario">
            {% for producto in productos %}
            <tr data-sku="{{ producto.sku }}" data-categoria="{{ producto.categoria.nombre }}">
              <td>{{ producto.sku }}</td>
              <td>
                <div class="producto-info">
                  {% if producto.imagen_principal %}
                  <img src="{{ producto.imagen_principal.imagen.url }}" alt="{{ producto.nombre }}" class="producto-thumb">
                  {% else %}
                  <div class="producto-thumb no-image">
                    <i class="fas fa-image"></i>
                  </div>
                  {% endif %}
                  <span>{{ producto.nombre }}</span>
                </div>
              </td>
              <td>{{ producto.categoria.nombre }}</td>
              <td class="num">{{ producto.stock }}</td>
              <td class="num">{{ producto.stock_minimo }}</td>
              <td>
                {% if producto.stock <= producto.stock_minimo %}
                  <span class="badge danger">Bajo Stock</span>
                {% elif not producto.activo %}
                  <span class="badge warning">Inactivo</span>
                {% else %}
                  <span class="badge ok">OK</span>
                {% endif %}
              </td>
              <td class="num">${{ producto.precio|floatformat:0 }}</td>
              <td class="actions">
                <a href="{% url 'movimiento_inventario_create' producto.id %}" class="btn-icon in" title="Entrada de stock">
                  <i class="fas fa-arrow-down"></i>
                </a>
                <a href="{% url 'movimiento_inventario_create' producto.id %}" class="btn-icon out" title="Salida de stock">
                  <i class="fas fa-arrow-up"></i>
                </a>
                <a href="{% url 'producto_edit' producto.id %}" class="btn-icon edit" title="Editar">
                  <i class="fas fa-pen"></i>
                </a>
                <form method="post" action="{% url 'producto_delete' producto.id %}" class="delete-form" style="display: inline;">
                  {% csrf_token %}
                  <button type="submit" class="btn-icon delete" title="Eliminar" onclick="return confirm('¿Estás seguro de eliminar {{ producto.nombre }}?')">
                    <i class="fas fa-trash"></i>
                  </button>
                </form>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="8" class="empty">
                {% if request.GET.q or request.GET.categoria or request.GET.estado %}
                No se encontraron productos con los filtros aplicados.
                {% else %}
                No hay productos cargados. <a href="{% url 'producto_create' %}">Crear primer producto</a>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>

        <!-- Paginación -->
        {% if productos.has_other_pages %}
        <div class="pager">
          {% if productos.has_previous %}
          <a href="?page={{ productos.previous_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.categoria %}&categoria={{ request.GET.categoria }}{% endif %}{% if request.GET.estado %}&estado={{ request.GET.estado }}{% endif %}" class="btn btn-outline">
            Anterior
          </a>
          {% endif %}

          <span class="page-info">
            Página {{ productos.number }} de {{ productos.paginator.num_pages }}
          </span>

          {% if productos.has_next %}
          <a href="?page={{ productos.next_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.categoria %}&categoria={{ request.GET.categoria }}{% endif %}{% if request.GET.estado %}&estado={{ request.GET.estado }}{% endif %}" class="btn btn-outline">
            Siguiente
          </a>
          {% endif %}
        </div>
        {% endif %}
      </section>
    </div>
  </main>
</div>

<!-- Modal para movimientos rápidos -->
<div class="modal" id="modalMovimiento" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-header">
      <h3 id="modalMovimientoTitle">Movimiento de Inventario</h3>
      <button class="close" id="closeMovimientoModal"><i class="fas fa-times"></i></button>
    </div>
    <form method="post" action="" class="modal-body" id="formMovimiento">
      {% csrf_token %}
      <div class="form-group">
        <label for="tipo_movimiento">Tipo de Movimiento:</label>
        <select name="tipo_movimiento" id="tipo_movimiento" class="input" required>
          <option value="ENTRADA">Entrada</option>
          <option value="SALIDA">Salida</option>
          <option value="AJUSTE">Ajuste</option>
        </select>
      </div>
      <div class="form-group">
        <label for="cantidad">Cantidad:</label>
        <input type="number" name="cantidad" id="cantidad" class="input" min="1" required>
      </div>
      <div class="form-group">
        <label for="observaciones">Observaciones:</label>
        <textarea name="observaciones" id="observaciones" class="input" rows="3" placeholder="Motivo del movimiento..."></textarea>
      </div>
      <div class="modal-actions">
        <button type="button" class="btn btn-outline" id="cancelarMovimiento">Cancelar</button>
        <button type="submit" class="btn btn-solid">Guardar Movimiento</button>
      </div>
    </form>
  </div>
</div>

<script src="{% static 'js/inventario.js' %}"></script>
<script>
// JavaScript mejorado para el control de inventario
document.addEventListener('DOMContentLoaded', function() {
  // Filtros en tiempo real
  const buscarInput = document.querySelector('input[name="q"]');
  const categoriaSelect = document.querySelector('select[name="categoria"]');
  const estadoSelect = document.querySelector('select[name="estado"]');
  
  function aplicarFiltros() {
    document.querySelector('.filter-form').submit();
  }
  
  // Buscar con delay
  let searchTimeout;
  buscarInput.addEventListener('input', function() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(aplicarFiltros, 500);
  });
  
  categoriaSelect.addEventListener('change', aplicarFiltros);
  estadoSelect.addEventListener('change', aplicarFiltros);

  // Modal de movimientos
  const movimientoModal = document.getElementById('modalMovimiento');
  const movimientoForm = document.getElementById('formMovimiento');
  let currentProductId = null;

  // Abrir modal para movimiento
  document.querySelectorAll('.btn-icon.in, .btn-icon.out').forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      const productRow = this.closest('tr');
      currentProductId = this.getAttribute('href').split('/').filter(Boolean).pop();
      
      // Configurar el formulario
      movimientoForm.action = `/inventario/movimiento/${currentProductId}/`;
      document.getElementById('modalMovimientoTitle').textContent = 
        `Movimiento - ${productRow.querySelector('td:nth-child(2) span').textContent}`;
      
      // Pre-configurar tipo de movimiento
      if (this.classList.contains('in')) {
        document.getElementById('tipo_movimiento').value = 'ENTRADA';
      } else {
        document.getElementById('tipo_movimiento').value = 'SALIDA';
      }
      
      movimientoModal.style.display = 'flex';
    });
  });

  // Cerrar modal
  document.getElementById('closeMovimientoModal').addEventListener('click', function() {
    movimientoModal.style.display = 'none';
  });

  document.getElementById('cancelarMovimiento').addEventListener('click', function() {
    movimientoModal.style.display = 'none';
  });

  // Cerrar modal al hacer clic fuera
  movimientoModal.addEventListener('click', function(e) {
    if (e.target === movimientoModal) {
      movimientoModal.style.display = 'none';
    }
  });

  // Confirmación para eliminación
  document.querySelectorAll('.delete-form').forEach(form => {
    form.addEventListener('submit', function(e) {
      if (!confirm('¿Estás seguro de que quieres eliminar este producto?')) {
        e.preventDefault();
      }
    });
  });

  // Mostrar/ocultar mensajes
  const messages = document.querySelector('.messages-container');
  if (messages) {
    setTimeout(() => {
      messages.style.opacity = '0';
      setTimeout(() => messages.remove(), 300);
    }, 5000);
  }
});
</script>

<style>
/* Estilos adicionales */
.messages-container {
  margin-bottom: 20px;
}

.alert {
  padding: 12px 16px;
  border-radius: 4px;
  margin-bottom: 10px;
}

.alert-success {
  background-color: #d4edda;
  border: 1px solid #c3e6cb;
  color: #155724;
}

.alert-error {
  background-color: #f8d7da;
  border: 1px solid #f5c6cb;
  color: #721c24;
}

.alert-warning {
  background-color: #fff3cd;
  border: 1px solid #ffeaa7;
  color: #856404;
}

.producto-info {
  display: flex;
  align-items: center;
  gap: 10px;
}

.producto-thumb {
  width: 40px;
  height: 40px;
  border-radius: 4px;
  object-fit: cover;
  border: 1px solid #ddd;
}

.producto-thumb.no-image {
  background: #f5f5f5;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #999;
}

.filter-form {
  display: flex;
  gap: 10px;
  align-items: center;
  flex-wrap: wrap;
}

.badge.warning {
  background-color: #ffc107;
  color: #000;
}

.delete-form {
  display: inline;
}

.page-info {
  padding: 8px 16px;
  color: #666;
}
</style>
</body>
</html>